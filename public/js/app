const API_URL = 'http://localhost:3000/api';

document.addEventListener('DOMContentLoaded', carregarColaboradores);

async function carregarColaboradores() {
    try {
        const response = await fetch(`${API_URL}/colaboradores`);
        const colaboradores = await response.json();
        renderizarTabela(colaboradores);
    } catch (error) {
        mostrarAlerta('Erro ao carregar colaboradores', 'danger');
    }
}

function renderizarTabela(colaboradores) {
    const tbody = document.getElementById('tabelaColaboradores');
    tbody.innerHTML = '';

    colaboradores.forEach(colab => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>
                <span class="badge ${colab.status === 'Ativo' ? 'bg-success' : 'bg-danger'}">
                    ${colab.status}
                </span>
            </td>
            <td>${colab.nome_completo}</td>
            <td>${colab.re}</td>
            <td>${colab.cargo}</td>
            <td>R$ ${formatarMoeda(colab.salario_atual)}</td>
            <td>${colab.empresas?.nome || '-'}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="editarColaborador(${colab.id})">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm ${colab.status === 'Ativo' ? 'btn-outline-danger' : 'btn-outline-success'}" 
                        onclick="toggleStatus(${colab.id}, '${colab.status}')">
                    <i class="bi ${colab.status === 'Ativo' ? 'bi-person-x' : 'bi-person-check'}"></i>
                </button>
                <button class="btn btn-sm btn-outline-warning" onclick="abrirReajuste(${colab.id}, ${colab.salario_atual})">
                    <i class="bi bi-cash-coin"></i>
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

async function salvarColaborador() {
    const id = document.getElementById('colaboradorId').value;
    const colaborador = {
        nome_completo: document.getElementById('nome').value,
        re: document.getElementById('re').value,
        cargo: document.getElementById('cargo').value,
        salario_atual: parseFloat(document.getElementById('salario').value),
        empresa_id: parseInt(document.getElementById('empresa').value),
        status: 'Ativo'
    };

    try {
        if (id) {
            await fetch(`${API_URL}/colaboradores/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(colaborador)
            });
            mostrarAlerta('Colaborador atualizado!', 'success');
        } else {
            await fetch(`${API_URL}/colaboradores`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(colaborador)
            });
            mostrarAlerta('Colaborador cadastrado!', 'success');
        }
        
        carregarColaboradores();
        fecharModal('modalCadastro');
    } catch (error) {
        mostrarAlerta('Erro ao salvar', 'danger');
    }
}

async function editarColaborador(id) {
    try {
        const response = await fetch(`${API_URL}/colaboradores`);
        const colaboradores = await response.json();
        const colaborador = colaboradores.find(c => c.id === id);

        document.getElementById('colaboradorId').value = colaborador.id;
        document.getElementById('nome').value = colaborador.nome_completo;
        document.getElementById('re').value = colaborador.re;
        document.getElementById('cargo').value = colaborador.cargo;
        document.getElementById('salario').value = colaborador.salario_atual;
        document.getElementById('empresa').value = colaborador.empresa_id;

        abrirModal('modalCadastro');
    } catch (error) {
        mostrarAlerta('Erro ao carregar dados', 'danger');
    }
}

async function toggleStatus(id, statusAtual) {
    const novoStatus = statusAtual === 'Ativo' ? 'Inativo' : 'Ativo';
    
    if (!confirm(`Deseja ${novoStatus === 'Ativo' ? 'reativar' : 'inativar'} este colaborador?`)) return;

    try {
        await fetch(`${API_URL}/colaboradores/${id}/status`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: novoStatus })
        });
        
        mostrarAlerta(`Colaborador ${novoStatus === 'Ativo' ? 'reativado' : 'inativado'}!`, 'success');
        carregarColaboradores();
    } catch (error) {
        mostrarAlerta('Erro ao alterar status', 'danger');
    }
}

function abrirReajuste(id, salarioAtual) {
    document.getElementById('reajusteId').value = id;
    document.getElementById('bonus').disabled = salarioAtual >= 1500;
    abrirModal('modalReajuste');
}

async function aplicarReajuste() {
    const id = document.getElementById('reajusteId').value;
    const percentual = parseFloat(document.getElementById('percentual').value);
    const bonus = document.getElementById('bonus').value ? parseFloat(document.getElementById('bonus').value) : null;

    try {
        const response = await fetch(`${API_URL}/colaboradores/${id}/reajuste`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ percentual, bonus })
        });

        const resultado = await response.json();
        
        if (resultado.success) {
            mostrarAlerta(`Reajuste aplicado! Novo sal√°rio: R$ ${formatarMoeda(resultado.novoSalario)}`, 'success');
            carregarColaboradores();
            fecharModal('modalReajuste');
        }
    } catch (error) {
        mostrarAlerta('Erro ao aplicar reajuste', 'danger');
    }
}

function abrirModal(id) {
    const modal = new bootstrap.Modal(document.getElementById(id));
    modal.show();
}

function fecharModal(id) {
    const modal = bootstrap.Modal.getInstance(document.getElementById(id));
    modal.hide();
    document.getElementById(id === 'modalCadastro' ? 'formColaborador' : 'formReajuste').reset();
    document.getElementById('colaboradorId').value = '';
}

function mostrarAlerta(mensagem, tipo) {
    const alerta = document.createElement('div');
    alerta.className = `alert alert-${tipo} alert-dismissible fade show position-fixed`;
    alerta.style.cssText = 'top: 20px; right: 20px; z-index: 1050;';
    alerta.innerHTML = `
        ${mensagem}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alerta);
    setTimeout(() => alerta.remove(), 3000);
}

function formatarMoeda(valor) {
    return parseFloat(valor).toFixed(2).replace('.', ',');
}
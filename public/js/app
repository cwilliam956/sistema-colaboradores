const API_URL = 'http://localhost:3000/api';

document.addEventListener('DOMContentLoaded', carregarColaboradores);

async function carregarColaboradores() {
    try {
        const response = await fetch(`${API_URL}/colaboradores`);
        const colaboradores = await response.json();
        renderizarTabela(colaboradores);
    } catch (error) {
        mostrarAlerta('Erro ao carregar colaboradores', 'danger');
    }
}

function renderizarTabela(colaboradores) {
    const tbody = document.getElementById('tabelaColaboradores');
    tbody.innerHTML = '';

    colaboradores.forEach(colab => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>
                <span class="badge ${colab.status === 'Ativo' ? 'bg-success' : 'bg-danger'}">
                    ${colab.status}
                </span>
            </td>
            <td>${colab.nome_completo}</td>
            <td><span class="badge bg-secondary">${colab.re}</span></td>
            <td>${colab.cargo}</td>
            <td>R$ ${formatarMoeda(colab.salario_atual)}</td>
            <td>${colab.salario_anterior ? 'R$ ' + formatarMoeda(colab.salario_anterior) : '-'}</td>
            <td>${colab.empresa || '-'}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="editarColaborador(${colab.id})">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm ${colab.status === 'Ativo' ? 'btn-outline-danger' : 'btn-outline-success'}" 
                        onclick="alterarStatus(${colab.id}, '${colab.status}')">
                    <i class="bi ${colab.status === 'Ativo' ? 'bi-person-x' : 'bi-person-check'}"></i>
                </button>
                <button class="btn btn-sm btn-outline-warning" onclick="abrirReajuste(${colab.id}, ${colab.salario_atual})">
                    <i class="bi bi-cash-coin"></i>
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function abrirModalCadastro() {
    document.getElementById('formColaborador').reset();
    document.getElementById('colaboradorId').value = '';
    document.getElementById('status').checked = true;
    
    const modal = new bootstrap.Modal(document.getElementById('modalCadastro'));
    modal.show();
}

async function salvarColaborador() {
    const form = document.getElementById('formColaborador');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const id = document.getElementById('colaboradorId').value;
    const colaborador = {
        nome_completo: document.getElementById('nomeCompleto').value,
        re: document.getElementById('re').value,
        cargo: document.getElementById('cargo').value,
        salario_atual: parseFloat(document.getElementById('salarioAtual').value),
        empresa: document.getElementById('empresa').value,
        status: document.getElementById('status').checked ? 'Ativo' : 'Inativo'
    };

    try {
        if (id) {
            await fetch(`${API_URL}/colaboradores/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(colaborador)
            });
            mostrarAlerta('Colaborador atualizado com sucesso!', 'success');
        } else {
            await fetch(`${API_URL}/colaboradores`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(colaborador)
            });
            mostrarAlerta('Colaborador cadastrado com sucesso!', 'success');
        }
        
        carregarColaboradores();
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalCadastro'));
        modal.hide();
    } catch (error) {
        mostrarAlerta('Erro ao salvar colaborador', 'danger');
    }
}

async function editarColaborador(id) {
    try {
        const response = await fetch(`${API_URL}/colaboradores`);
        const colaboradores = await response.json();
        const colaborador = colaboradores.find(c => c.id === id);

        if (colaborador) {
            document.getElementById('colaboradorId').value = colaborador.id;
            document.getElementById('nomeCompleto').value = colaborador.nome_completo;
            document.getElementById('re').value = colaborador.re;
            document.getElementById('cargo').value = colaborador.cargo;
            document.getElementById('salarioAtual').value = colaborador.salario_atual;
            document.getElementById('empresa').value = colaborador.empresa;
            document.getElementById('status').checked = colaborador.status === 'Ativo';

            const modal = new bootstrap.Modal(document.getElementById('modalCadastro'));
            modal.show();
        }
    } catch (error) {
        mostrarAlerta('Erro ao carregar dados do colaborador', 'danger');
    }
}

async function alterarStatus(id, statusAtual) {
    const novoStatus = statusAtual === 'Ativo' ? 'Inativo' : 'Ativo';
    const confirmacao = confirm(`Deseja ${novoStatus === 'Ativo' ? 'reativar' : 'inativar'} este colaborador?`);

    if (!confirmacao) return;

    try {
        await fetch(`${API_URL}/colaboradores/${id}/status`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: novoStatus })
        });

        mostrarAlerta(`Colaborador ${novoStatus === 'Ativo' ? 'reativado' : 'inativado'} com sucesso!`, 'success');
        carregarColaboradores();
    } catch (error) {
        mostrarAlerta('Erro ao alterar status do colaborador', 'danger');
    }
}

function abrirReajuste(id, salarioAtual) {
    document.getElementById('reajusteId').value = id;
    
    const bonusInput = document.getElementById('bonusAdicional');
    if (salarioAtual < 1500) {
        bonusInput.disabled = false;
        bonusInput.placeholder = 'Bônus disponível';
    } else {
        bonusInput.disabled = true;
        bonusInput.placeholder = 'Não disponível (salário ≥ R$ 1.500)';
    }

    const modal = new bootstrap.Modal(document.getElementById('modalReajuste'));
    modal.show();
}

async function aplicarReajuste() {
    const id = document.getElementById('reajusteId').value;
    const percentual = parseFloat(document.getElementById('percentualAumento').value);
    const bonus = document.getElementById('bonusAdicional').value ? 
        parseFloat(document.getElementById('bonusAdicional').value) : null;

    if (!percentual || percentual <= 0) {
        mostrarAlerta('Informe um percentual válido', 'warning');
        return;
    }

    try {
        const response = await fetch(`${API_URL}/colaboradores/${id}/reajuste`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ percentual, bonus })
        });

        const resultado = await response.json();

        if (resultado.success) {
            mostrarAlerta(
                `Reajuste aplicado com sucesso! Novo salário: R$ ${formatarMoeda(resultado.novoSalario)}`,
                'success'
            );
            carregarColaboradores();
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalReajuste'));
            modal.hide();
        }
    } catch (error) {
        mostrarAlerta('Erro ao aplicar reajuste salarial', 'danger');
    }
}

function mostrarAlerta(mensagem, tipo) {
    const alerta = document.createElement('div');
    alerta.className = `alert alert-${tipo} alert-dismissible fade show position-fixed`;
    alerta.style.cssText = 'top: 20px; right: 20px; z-index: 1050;';
    alerta.innerHTML = `
        ${mensagem}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alerta);
    setTimeout(() => alerta.remove(), 3000);
}

function formatarMoeda(valor) {
    return parseFloat(valor).toFixed(2).replace('.', ',');
}
const express = require('express');
const cors = require('cors');
require('dotenv').config();
const path = require('path');
const { createClient } = require('@supabase/supabase-js');

const app = express();
const PORT = process.env.PORT || 3000;

// Configurar Supabase
const supabaseUrl = process.env.SUPABASE_URL || 'https://quogfnghodblondzlkfm.supabase.co';
const supabaseKey = process.env.SUPABASE_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF1b2dmbmdob2RibG9uZHpsa2ZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzM2Mjg4ODMsImV4cCI6MjA0OTIwNDg4M30.3fVILyWn0Jou1iDyE4Bhdg_BQyiin1K';
const supabase = createClient(supabaseUrl, supabaseKey);

// Middleware
app.use(cors());
app.use(express.json());
app.use(express.static('public'));
app.use(express.static('views'));

// Rota principal
app.get('/', (req, res) => {
    res.sendFile(path.join(__dirname, 'views', 'index.html'));
});

// API: Listar todos colaboradores
app.get('/api/colaboradores', async (req, res) => {
    try {
        const { data, error } = await supabase
            .from('colaboradores')
            .select(`
                *,
                empresas (nome)
            `)
            .order('id', { ascending: true });

        if (error) throw error;
        res.json(data);
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// API: Buscar colaborador por ID
app.get('/api/colaboradores/:id', async (req, res) => {
    try {
        const { data, error } = await supabase
            .from('colaboradores')
            .select(`
                *,
                empresas (nome)
            `)
            .eq('id', req.params.id)
            .single();

        if (error) throw error;
        res.json(data);
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// API: Criar novo colaborador
app.post('/api/colaboradores', async (req, res) => {
    try {
        const { data, error } = await supabase
            .from('colaboradores')
            .insert([{
                ...req.body,
                created_at: new Date(),
                updated_at: new Date()
            }])
            .select()
            .single();

        if (error) throw error;
        res.json(data);
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// API: Atualizar colaborador
app.put('/api/colaboradores/:id', async (req, res) => {
    try {
        const { data, error } = await supabase
            .from('colaboradores')
            .update({
                ...req.body,
                updated_at: new Date()
            })
            .eq('id', req.params.id)
            .select()
            .single();

        if (error) throw error;
        res.json(data);
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// API: Aplicar reajuste salarial
app.post('/api/colaboradores/:id/reajuste', async (req, res) => {
    try {
        const { percentual, bonus } = req.body;
        
        // 1. Buscar colaborador
        const { data: colaborador, error: errorColab } = await supabase
            .from('colaboradores')
            .select('*')
            .eq('id', req.params.id)
            .single();

        if (errorColab) throw errorColab;
        if (!colaborador) {
            return res.status(404).json({ error: 'Colaborador nÃ£o encontrado' });
        }

        // 2. Calcular novo salÃ¡rio
        let novoSalario = colaborador.salario_atual * (1 + percentual / 100);
        
        // 3. Aplicar bÃ´nus se salÃ¡rio < 1500 e bÃ´nus informado
        if (colaborador.salario_atual < 1500 && bonus) {
            novoSalario += bonus;
        }

        // 4. Atualizar colaborador
        const { data: updatedColab, error: updateError } = await supabase
            .from('colaboradores')
            .update({
                salario_anterior: colaborador.salario_atual,
                salario_atual: novoSalario,
                updated_at: new Date()
            })
            .eq('id', req.params.id)
            .select()
            .single();

        if (updateError) throw updateError;

        // 5. Registrar no histÃ³rico
        const { error: histError } = await supabase
            .from('historico_reajustes')
            .insert({
                colaborador_id: req.params.id,
                percentual_aumento: percentual,
                bonus_adicional: bonus || 0,
                salario_anterior: colaborador.salario_atual,
                salario_novo: novoSalario,
                data_reajuste: new Date()
            });

        if (histError) throw histError;

        res.json({
            success: true,
            message: 'Reajuste aplicado com sucesso',
            salarioAnterior: colaborador.salario_atual,
            novoSalario: novoSalario,
            colaborador: updatedColab
        });

    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// API: Listar empresas
app.get('/api/empresas', async (req, res) => {
    try {
        const { data, error } = await supabase
            .from('empresas')
            .select('*')
            .order('nome');

        if (error) throw error;
        res.json(data);
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// API: Alterar status do colaborador
app.patch('/api/colaboradores/:id/status', async (req, res) => {
    try {
        const { status } = req.body;
        
        const updateData = {
            status: status,
            updated_at: new Date()
        };
        
        if (status === 'Inativo') {
            updateData.data_desativacao = new Date();
        } else {
            updateData.data_desativacao = null;
        }

        const { data, error } = await supabase
            .from('colaboradores')
            .update(updateData)
            .eq('id', req.params.id)
            .select()
            .single();

        if (error) throw error;
        res.json(data);
    } catch (error) {
        res.status(500).json({ error: error.message });
    }
});

// Iniciar servidor
app.listen(PORT, () => {
    console.log(`âœ… Servidor rodando na porta ${PORT}`);
    console.log(`ðŸ“Š Acesse: http://localhost:${PORT}`);
    console.log(`ðŸ”— Supabase URL: ${supabaseUrl}`);
});